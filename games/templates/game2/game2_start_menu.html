{%extends "start_menu_template.html"%}
{% load static %}

{%block menutitle%} A Day in School: Crisis {%endblock%}

{%block stylelink %}
<link rel="stylesheet" href="{% static 'css/game2_menu.css' %}" >
{%endblock%}
{% block style %}
{% endblock %}

{%block script %}

console.log(document.getElementById('instruction').innerHTML)
function startListening() {
    if (!('webkitSpeechRecognition' in window)) {
        alert("Not supported. Try again.");
        return;
    }

    let recognition = new webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = "en-US";

    recognition.onstart = function() {
        document.getElementById("status").innerText = "Listening...";
    };

    // event.result[0] = [
    //     {transcript: "The answer is right", confidence: 0.97},
    //     {transcript: "The answer is write", confidence: 0.80},
    // ]
    recognition.onresult = function(event) {
        let command = event.results[0][0].transcript.trim();
        document.getElementById("status").innerText = "Recognition complete.";
        document.getElementById('input_box').setAttribute('placeholder', command)


    };

    recognition.start();
}

function sendData() {
    let username = document.getElementById("username").value;

    fetch('/process/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken() // Get CSRF token dynamically
        },
        body: JSON.stringify({ username: username })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById("response").innerText = data.message;
    })
    .catch(error => console.error("Error:", error));
}

// Function to get CSRF token from Django (required for security)
function getCSRFToken() {
    let cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        let cookie = cookies[i].trim();
        if (cookie.startsWith("csrftoken=")) {
            return cookie.substring("csrftoken=".length, cookie.length);
        }
    }
    return "";
}

document.getElementById('storm').volume = 0.5
document.getElementsByTagName("body")[0].style = "background-image: url('static/images/elementary_school.jpg');"

//html
let voices = [];

function loadVoices() {
    voices = window.speechSynthesis.getVoices();
    let voiceSelect = document.getElementById("voiceSelect");

    voiceSelect.innerHTML = ''; // Clear previous options
   
    voices.forEach((voice, index) => {
        let option = document.createElement("option");
        option.value = index;
        option.onclick = function(){console.log(option)}
        option.textContent = voice.name;
        voiceSelect.appendChild(option);
    });

    voiceSelect.onclick = function(){
        e = document.getElementById('voiceSelect') 
        console.log(e.options[e.selectedIndex].text)}
}
window.speechSynthesis.onvoiceschanged = loadVoices;
window.addEventListener("load", loadVoices);

function speakText() {
    let text = document.getElementById("instruction").innerText;
    console.log(text)
    let speech = new SpeechSynthesisUtterance(text); // text="Hello World"
    window.speechSynthesis.cancel()
    let voiceSelect = document.getElementById("voiceSelect");

    if (voices.length > 0) {
        speech.voice = voices[185];
        console.log(voiceSelect.value)
    }

    speech.lang = "en-US";
    speech.rate = 1; // slow to fast
    speech.pitch = 1; // deep to high
    speech.volume = 1; // mute to loud

   // let mouth = document.getElementById("robotMouth");

    // Animate Mouth
  //  mouth.classList.add("talking");

   // speech.onend = function() {
   //     mouth.classList.remove("talking");
 //  };

    window.speechSynthesis.speak(speech);
}


{%endblock%}

{%block content%} 

<div id = center_panel> 

    <div id = 'instruction'>

        <h2 style = 'background-color: white; color: red; border-radius: 10px; margin-top: -15%; text-align: center; border-style: solid; border-width: 4px; border-color: pink; '> Instruction</h2>
        The game is a visual novel<br>
        Basically a novel with graphics<br>
        You advance the dialogue <br>
        by clicking anywhere on the screen<br>
        And you need to make decision on what to say <br>
        Your choice will affect how the story goes <br>
        So please pay attention to dialogue <br>
        and choose what to say carefully <br>
    </div>

    <form action="{% url 'game2_play' %}" method = "GET" >
    <div id = name_input>
        
        <h2 style = 'background-color: white; color: red; border-radius: 10px; margin: 4%; text-align: center; border-style: solid; border-width: 4px; border-color: pink; '>Your Name</h2>
        <input type = 'text' id = input_box placeholder="Dante" name = 'userInput' style = 'margin: 5%; border-radius: 20px; padding: 2%; text-align: center;'>
        <p style = 'font-size: 20px; margin-top: -2%; margin-left: 4%; margin-right: 4%;'>Enter your name. <br><br>You can either type or speak out your name <br></p>

    </div>
    <p id="status">Press the button and say something...</p>
    <p id = 'result'></p>


    <button class="game-button" id = 'ref' type = 'submit' onclick =  'function () {sendData() window.location.href = "{% url 'game2_play' %}"}' style = 'margin-top: 20%;'>
        Start Game
    </button>
    </form>


    <button class="mic-button" onclick="startListening()" >Start Listening</button>

    <div id = 'qr_code'>
        sdfsdfsdf
    </div>


    <div id="instructionBox">
        <p id="instructionText">Welcome to the game! Move arrow keys to navigate through the maze.</p>
        <label for="voiceSelect">Choose Voice:</label>
        <select id="voiceSelect" style = 'visibility: hidden;'></select>
        <button onclick="speakText()">Read Aloud</button>
    </div>
    
</div>



<audio autoplay loop id = 'storm'>
    <source src = "{% static 'sound/storm.mp3' %}" type="audio/mpeg">
</audio>



{% endblock %}




{%block ref %}


{% endblock %}